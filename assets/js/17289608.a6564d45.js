"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[8384],{24213:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>i,contentTitle:()=>l,default:()=>d,frontMatter:()=>a,metadata:()=>o,toc:()=>m});var s=r(74848),t=r(28453);const a={},l=void 0,o={id:"operation/Prometheus/\u914d\u7f6ealertmanager\u548c\u9489\u9489\u544a\u8b66",title:"\u914d\u7f6ealertmanager\u548c\u9489\u9489\u544a\u8b66",description:"prometheus\u53d1\u8d77\u544a\u8b66\u7684\u903b\u8f91",source:"@site/docs/operation/Prometheus/\u914d\u7f6ealertmanager\u548c\u9489\u9489\u544a\u8b66.md",sourceDirName:"operation/Prometheus",slug:"/operation/Prometheus/\u914d\u7f6ealertmanager\u548c\u9489\u9489\u544a\u8b66",permalink:"/docs/operation/Prometheus/\u914d\u7f6ealertmanager\u548c\u9489\u9489\u544a\u8b66",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"opsSidebar",previous:{title:"\u76d1\u63a7nginx",permalink:"/docs/operation/Prometheus/\u76d1\u63a7nginx"}},i={},m=[{value:"prometheus\u53d1\u8d77\u544a\u8b66\u7684\u903b\u8f91",id:"prometheus\u53d1\u8d77\u544a\u8b66\u7684\u903b\u8f91",level:2},{value:"\u8282\u70b9",id:"\u8282\u70b9",level:2},{value:"\u914d\u7f6ealertmanager",id:"\u914d\u7f6ealertmanager",level:2},{value:"\u914d\u7f6e\u9489\u9489\u544a\u8b66\u63d2\u4ef6",id:"\u914d\u7f6e\u9489\u9489\u544a\u8b66\u63d2\u4ef6",level:2},{value:"\u914d\u7f6esupervisor\u5b88\u62a4\u8fdb\u7a0b",id:"\u914d\u7f6esupervisor\u5b88\u62a4\u8fdb\u7a0b",level:2},{value:"\u5173\u8054prometheus\u548calertmanager",id:"\u5173\u8054prometheus\u548calertmanager",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"prometheus\u53d1\u8d77\u544a\u8b66\u7684\u903b\u8f91",children:"prometheus\u53d1\u8d77\u544a\u8b66\u7684\u903b\u8f91"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"\u5047\u8bbeA\u670d\u52a1\u5668\u548cprometheus\u670d\u52a1\u5668\u65ad\u8054\uff0c\u4e14\u5df2\u7ecf\u8d85\u8fc7\u4e00\u5206\u949f\uff0c\u5339\u914d\u4e0a\u76d1\u6d4b\u5b58\u6d3b\u7684\u544a\u8b66\u89c4\u5219"}),"\n",(0,s.jsx)(n.li,{children:"Prometheus\u5411alertmanager\u62a5\u4fe1\uff0cA\u670d\u52a1\u5668\u65ad\u8054"}),"\n",(0,s.jsx)(n.li,{children:"alertmanager\u8c03\u7528\u9489\u9489\u544a\u8b66\u63d2\u4ef6\uff0c\u53d1\u8d77\u544a\u8b66"}),"\n",(0,s.jsx)(n.li,{children:"\u9489\u9489\u673a\u5668\u4eba\u5728\u7fa4\u91cc\u53d1\u6d88\u606f\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u8282\u70b9",children:"\u8282\u70b9"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"172.50.13.101\uff1aprometheus server"}),"\n",(0,s.jsx)(n.li,{children:"172.50.13.102\uff1aalertmanager\u548c\u9489\u9489\u544a\u8b66\u63d2\u4ef6"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u914d\u7f6ealertmanager",children:"\u914d\u7f6ealertmanager"}),"\n",(0,s.jsxs)(n.p,{children:["\u9996\u5148\u80af\u5b9a\u8981\u53bb\u5b98\u65b9\u4e0b\u8f7dalertmanager\u3002",(0,s.jsx)(n.a,{href:"https://github.com/prometheus/alertmanager",children:"GitHub - prometheus/alertmanager: Prometheus Alertmanager"})]}),"\n",(0,s.jsx)(n.p,{children:"\u5b89\u88c5\u5f88\u7b80\u5355\uff0c\u89e3\u538b\u7f29\u5c31\u884c\u4e86\u3002"}),"\n",(0,s.jsx)(n.p,{children:"alertmanager.yml\u6587\u4ef6\u5185\u5bb9\uff1a\uff08receiver\u4e2d\u7684url\u5e94\u8be5\u4e3a\u9489\u9489\u544a\u8b66\u63d2\u4ef6\u7684url\uff09"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"global:\n  resolve_timeout: 5m\n\nroute:\n  group_by: [alertname]\n  group_wait: 10s\n  group_interval: 10s\n  repeat_interval: 2h\n  receiver: webhook\nreceivers:\n- name: webhook\n  webhook_configs:\n  - url: 'http://172.50.13.102:8060/dingtalk/webhook1/send'\n    send_resolved: true\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u914d\u7f6e\u9489\u9489\u544a\u8b66\u63d2\u4ef6",children:"\u914d\u7f6e\u9489\u9489\u544a\u8b66\u63d2\u4ef6"}),"\n",(0,s.jsxs)(n.p,{children:["\u63d2\u4ef6\u4e0b\u8f7d\u5730\u5740\uff1a",(0,s.jsx)(n.a,{href:"https://github.com/timonwong/prometheus-webhook-dingtalk/releases",children:"Releases \xb7 timonwong/prometheus-webhook-dingtalk \xb7 GitHub"})]}),"\n",(0,s.jsx)(n.p,{children:"\u53ea\u662f\u80fd\u7528\u7684\u8bdd\uff0c\u89e3\u538b\u7f29\u5c31\u884c\u4e86\uff0c\u4e0d\u9700\u8981\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u914d\u7f6esupervisor\u5b88\u62a4\u8fdb\u7a0b",children:"\u914d\u7f6esupervisor\u5b88\u62a4\u8fdb\u7a0b"}),"\n",(0,s.jsx)(n.p,{children:"vim /etc/supervisord.d/prometheus.ini"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:'[program:alertmanager]\ncommand=/usr/local/prometheus/alertmanager/alertmanager --storage.path="/home/data/prometheus/alertmanager/" --web.listen-address=":18081" --config.file=/usr/local/prometheus/alertmanager/alertmanager.yml --data.retention=120h --web.external-url=http://172.50.13.102:18081\ndirectory=/usr/local/prometheus/alertmanager\nautostart=true\nstartsecs=10\nstartretries=3\nautorestart=true\n\n[program:dingtalk]\ncommand=/usr/local/prometheus/dingtalk/prometheus-webhook-dingtalk --ding.profile="webhook1=https://oapi.dingtalk.com/robot/send?access_token=xxxx"\ndirectory=/usr/local/prometheus/dingtalk\nautostart=true\nstartsecs=10\nstartretries=3\nautorestart=true\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u542f\u52a8\u53c2\u6570\u8bf4\u660e\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["alertmanager\uff1a","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"storage.path\uff1a\u6570\u636e\u5b58\u50a8\u8def\u5f84"}),"\n",(0,s.jsx)(n.li,{children:"web.listen.addreess\uff1a\u76d1\u542c\u7aef\u53e3"}),"\n",(0,s.jsx)(n.li,{children:"config.file\uff1aalertmanager.yml\u6587\u4ef6\u7684\u8def\u5f84"}),"\n",(0,s.jsx)(n.li,{children:"data.retention\uff1a\u6570\u636e\u5b58\u50a8\u65f6\u95f4"}),"\n",(0,s.jsx)(n.li,{children:"web.external-url\uff1a\u542f\u7528web\u9875\u9762\u5e76\u914d\u7f6e\u5730\u5740"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["dingtalk\uff1a","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"ding.profile\uff1a\u6ce8\u610fwebhook1\u540e\u9762\u66ff\u6362\u4e3a\u5b9e\u9645\u9489\u9489\u673a\u5668\u4eba\u7684webhook"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u5173\u8054prometheus\u548calertmanager",children:"\u5173\u8054prometheus\u548calertmanager"}),"\n",(0,s.jsx)(n.p,{children:"prometheus.yml\u4e2d\u4e3b\u8981\u7684\u914d\u7f6e\u5185\u5bb9\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# Alertmanager configuration\nalerting:\n  alertmanagers:\n  - static_configs:\n    - targets: [\'172.50.13.102:18081\']\n\n# Load rules once and periodically evaluate them according to the global \'evaluation_interval\'.\nrule_files:\n  # - "first_rules.yml"\n  # - "second_rules.yml"\n  - "alertrules/*_rules.yml"\n'})}),"\n",(0,s.jsx)(n.p,{children:"targets\u4e3aalertmanager\u7684\u5730\u5740\u3002rule_files\u4e3a\u544a\u8b66\u89c4\u5219\u6587\u4ef6\uff0c\u6b64\u5904\u4e3a\u540c\u7ea7\u76ee\u5f55\u4e2dalertrules\u76ee\u5f55\u4e0b\u6240\u6709\u5e26\u201c_rules.yml\u201d\u540e\u7f00\u7684\u6587\u4ef6\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u76d1\u6d4b\u5b58\u6d3b\u7684\u544a\u8b66\u89c4\u5219\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"alertrules/live_rules.yml"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'groups:\n- name: UP\n  rules:\n  - alert : node\n    expr: up == 0\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      description: "{{ $labels.job }} {{ $labels.instance }} \u8282\u70b9\u65ad\u8054\u5df2\u8d85\u8fc71\u5206\u949f\uff01"\n      summary: "{{ $labels.instance }} down "\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u76d1\u6d4b\u8d1f\u8f7d\u7684\u544a\u8b66\u89c4\u5219\uff1a\uff08\u76d1\u6d4b\u5185\u5b58\uff0c\u78c1\u76d8\u5360\u7528\u7387\u548cCPU\u4f7f\u7528\u7387\uff09"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"alertrules/perf_rules.yml"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'groups:\n- name: mem_product \n  rules:\n  - alert : mem_product\n    expr: (1 - (node_memory_MemAvailable_bytes{job="\u751f\u4ea7\u670d\u52a1\u5668"} / (node_memory_MemTotal_bytes{job="\u751f\u4ea7\u670d\u52a1\u5668"})))* 100  > 90\n    for: 5m\n    labels:\n      severity: critical\n    annotations:\n      description: "{{ $labels.job }} {{ $labels.instance }} \u8282\u70b9\u7684\u5185\u5b58\u4f7f\u7528\u7387\u8d85\u8fc790%\u5df2\u6301\u7eed5\u5206\u949f\uff01"\n      summary: "{{ $labels.instance }} \u5185\u5b58\u4f7f\u7528\u7387\u8d85\u6807\uff01 "\n\n\n- name: disk\n  rules:\n  - alert : disk\n    expr: (node_filesystem_size_bytes{fstype=~"ext.*|xfs",mountpoint !~".*pod.*"}-node_filesystem_free_bytes{fstype=~"ext.*|xfs",mountpoint !~".*pod.*"}) *100/(node_filesystem_avail_bytes {fstype=~"ext.*|xfs",mountpoint !~".*pod.*"}+(node_filesystem_size_bytes{fstype=~"ext.*|xfs",mountpoint !~".*pod.*"}-node_filesystem_free_bytes{fstype=~"ext.*|xfs",mountpoint !~".*pod.*"})) > 95\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      description: "{{ $labels.job }} {{ $labels.instance }} \u8282\u70b9\u7684\u786c\u76d8\u4f7f\u7528\u7387\u8d85\u8fc795%\u5df2\u6301\u7eed5\u5206\u949f\uff01"\n      summary: "{{ $labels.instance }} \u786c\u76d8\u7a7a\u95f4\u4f7f\u7528\u7387\u8d85\u6807\uff01 "\n\n- name: cpu\n  rules:\n  - alert : cpu\n    expr: ((1- sum(increase(node_cpu_seconds_total{mode="idle"}[5m])) by (instance)/sum(increase(node_cpu_seconds_total[5m])) by (instance)) * 100) >  70\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      description: "{{ $labels.job }} {{ $labels.instance }} \u8282\u70b9\u7684CPU\u4f7f\u7528\u7387\u8d85\u8fc770%\u5df2\u6301\u7eed5\u5206\u949f\uff01"\n      summary: "{{ $labels.instance }} CPU\u4f7f\u7528\u7387\u8d85\u6807\uff01"\n'})})]})}function d(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>l,x:()=>o});var s=r(96540);const t={},a=s.createContext(t);function l(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);