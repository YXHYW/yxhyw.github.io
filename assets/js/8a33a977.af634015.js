"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[524],{82118:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>a});var r=s(74848),l=s(28453);const i={sidebar_position:1,description:"\u8bbe\u7f6epostgres\u7684\u5f52\u6863\u6a21\u5f0f"},o=void 0,t={id:"database/PostgreSQL/\u5907\u4efd\u4e0e\u6062\u590d/\u5f52\u6863\u6a21\u5f0f",title:"\u5f52\u6863\u6a21\u5f0f",description:"\u8bbe\u7f6epostgres\u7684\u5f52\u6863\u6a21\u5f0f",source:"@site/docs/database/PostgreSQL/\u5907\u4efd\u4e0e\u6062\u590d/\u5f52\u6863\u6a21\u5f0f.md",sourceDirName:"database/PostgreSQL/\u5907\u4efd\u4e0e\u6062\u590d",slug:"/database/PostgreSQL/\u5907\u4efd\u4e0e\u6062\u590d/\u5f52\u6863\u6a21\u5f0f",permalink:"/docs/database/PostgreSQL/\u5907\u4efd\u4e0e\u6062\u590d/\u5f52\u6863\u6a21\u5f0f",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,description:"\u8bbe\u7f6epostgres\u7684\u5f52\u6863\u6a21\u5f0f"},sidebar:"dbSidebar",previous:{title:"\u5907\u4efd\u4e0e\u6062\u590d",permalink:"/docs/category/\u5907\u4efd\u4e0e\u6062\u590d"},next:{title:"\u903b\u8f91\u5907\u4efd\u4e0e\u8fd8\u539f",permalink:"/docs/database/PostgreSQL/\u5907\u4efd\u4e0e\u6062\u590d/\u903b\u8f91\u5907\u4efd\u4e0e\u8fd8\u539f"}},c={},a=[{value:"\u524d\u8a00",id:"\u524d\u8a00",level:2},{value:"\u914d\u7f6e\u6b65\u9aa4",id:"\u914d\u7f6e\u6b65\u9aa4",level:2},{value:"\u81ea\u52a8\u6e05\u7406\u5f52\u6863\u65e5\u5fd7\u6587\u4ef6\u7684shell\u811a\u672c",id:"\u81ea\u52a8\u6e05\u7406\u5f52\u6863\u65e5\u5fd7\u6587\u4ef6\u7684shell\u811a\u672c",level:2},{value:"\u53c2\u8003",id:"\u53c2\u8003",level:2}];function d(e){const n={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"\u524d\u8a00",children:"\u524d\u8a00"}),"\n",(0,r.jsx)(n.p,{children:"\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cpostgres\u672a\u5f00\u542f\u5f52\u6863\u6a21\u5f0f\u3002\u5f53\u91cd\u505a\u65e5\u5fd7\u88ab\u5199\u6ee1\u65f6\uff0c\u4e4b\u524d\u7684\u91cd\u505a\u65e5\u5fd7\u4fe1\u606f\u5c06\u88ab\u8986\u76d6\uff0c\u8fd9\u5c31\u53ef\u80fd\u5bfc\u81f4\u91cd\u505a\u65e5\u5fd7\u4fe1\u606f\u7684\u4e22\u5931\u3002\u4e3a\u4e86\u4fdd\u8bc1\u6240\u6709\u7684\u91cd\u505a\u65e5\u5fd7\u4e0d\u88ab\u8986\u76d6\uff0c\u751f\u4ea7\u73af\u5883\u4e0b\u4e00\u822c\u542f\u7528\u5f52\u6863\u6a21\u5f0f\u3002\u5f53\u91cd\u505a\u65e5\u5fd7\u88ab\u5199\u6ee1\uff0cpg\u5148\u4ea7\u751f\u5f52\u6863\u65e5\u5fd7\u6587\u4ef6\u4ee5\u5907\u4efd\u91cd\u505a\u65e5\u5fd7\uff0c\u7136\u540e\u518d\u8986\u76d6\u91cd\u505a\u65e5\u5fd7\u6587\u4ef6\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"\u914d\u7f6e\u6b65\u9aa4",children:"\u914d\u7f6e\u6b65\u9aa4"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5728psql\u4e2d\u67e5\u770b\u5f53\u524d\u7684\u5f52\u6863\u6a21\u5f0f\u3002\u9ed8\u8ba4\u4e3a",(0,r.jsx)(n.code,{children:"off"}),"\uff0c\u4e5f\u5c31\u662f\u672a\u5f00\u542f\u5f52\u6863\u6a21\u5f0f\u3002"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"show archive_mode;\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"\u521b\u5efa\u5f52\u6863\u65e5\u5fd7\u76ee\u5f55\u3002\u4e2a\u4eba\u4e60\u60ef\u5728\u6570\u636e\u76ee\u5f55\u4e0b\u521b\u5efa\uff0c\u53ef\u6839\u636e\u5b9e\u9645\u9700\u6c42\u4fee\u6539\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"mkdir -p /home/postgres/apps/pgsql/data/archivelog\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsx)(n.li,{children:"\u4fee\u6539postgresql.conf\u6587\u4ef6"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"# \u5f00\u542f\u5f52\u6863\u6a21\u5f0f\narchive_mode = on\n# \u914d\u7f6e\u5f52\u6863\u547d\u4ee4\narchive_command = 'log_dt=$(date +%Y%m%d);log_dir=\"/home/postgres/apps/pgsql/data/archivelog/${log_dt}\";(test -d ${log_dir} || mkdir -p ${log_dir}) && cp %p ${log_dir}/%f'\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"4",children:["\n",(0,r.jsx)(n.li,{children:"\u91cd\u542fpostgres"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"pg_ctl restart -D /home/postgres/apps/pgsql/data/\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"5",children:["\n",(0,r.jsx)(n.li,{children:"\u4f7f\u7528psql\u767b\u5f55\u63a7\u5236\u53f0\u786e\u8ba4"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \u67e5\u770b\u5f52\u6863\u6a21\u5f0f, \u6b64\u65f6\u5e94\u8be5\u4e3aon\nshow archive_mode;\n\n-- \u67e5\u770b\u9884\u5199\u65e5\u5fd7\u5217\u8868\nselect * from  pg_ls_waldir() order by modification desc;\n\n-- \u624b\u52a8\u5207\u6362\u65e5\u5fd7\ncheckpoint;  -- \u89e6\u53d1\u4e00\u4e2a\u5b8c\u5168\u68c0\u67e5\u70b9, \u4ee5\u53ca\u5c06\u5185\u5b58\u4e2d\u7684\u810f\u6570\u636e\u5199\u5165\u6570\u636e\u6587\u4ef6\nselect pg_switch_wal();\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"6",children:["\n",(0,r.jsx)(n.li,{children:"\u67e5\u770b\u5f52\u6863\u6587\u4ef6"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"/home/postgres/apps/pgsql/data/archivelog\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u81ea\u52a8\u6e05\u7406\u5f52\u6863\u65e5\u5fd7\u6587\u4ef6\u7684shell\u811a\u672c",children:"\u81ea\u52a8\u6e05\u7406\u5f52\u6863\u65e5\u5fd7\u6587\u4ef6\u7684shell\u811a\u672c"}),"\n",(0,r.jsx)(n.p,{children:"\u867d\u7136\u90fd\u662f\u5199shell\u811a\u672c\uff0c\u4f46\u6709\u4e24\u79cd\u914d\u7f6e\u81ea\u52a8\u6267\u884c\u7684\u65b9\u5f0f\u3002\u4e00\u79cd\u662f\u5199\u5728postgresql.conf\u4e2d\u7684archive_command\u4e2d\uff0c\u6bcf\u6b21\u521b\u5efa\u5f52\u6863\u65e5\u5fd7\u7684\u65f6\u5019\u8c03\u7528\u3002\u53e6\u4e00\u79cd\u662f\u642d\u914dcrontab\u3002crontab\u65b9\u5f0f\u8ddf\u914d\u7f6earchive_command\u65b9\u5f0f\u5dee\u4e0d\u591a\uff0c\u53ea\u4e0d\u8fc7\u7701\u53bb\u4f20\u53c2\uff0c\u76f4\u63a5\u914d\u7f6ecrontab\u5b9a\u65f6\u5220\u9664\u5373\u53ef\u3002\u4ee5\u4e0b\u4e3a\u914d\u7f6earchive_command\u7684\u6b65\u9aa4\u3002"}),"\n",(0,r.jsx)(n.p,{children:"\u811a\u672c\u5185\u5bb9"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n\nset -u\n\nlog_dt=$(date +%F)\narchivelog_dir="/home/postgres/apps/pgsql/data/archivelog/${log_dt}"\n\nif [ ! -d "${archivelog_dir}/$1" ]; then\n    mkdir -p "${archivelog_dir}/$1"\nfi\n\ncp --preserve=timestamps $2 ${archivelog_dir}/$1\n\nfind ${archivelog_dir}/* -type f -mtime +7 | xargs rm -f\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u4fee\u6539postgresql.conf\u6587\u4ef6"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"archive_command = 'bash /home/postgres/scripts/clean_archivelog.sh %f %p'\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u53c2\u8003",children:"\u53c2\u8003"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u8d75\u6e1d\u5f3a\u300aPostgreSQL\u6570\u636e\u5e93\u5b9e\u6218\u6d3e\u300b"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>t});var r=s(96540);const l={},i=r.createContext(l);function o(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);