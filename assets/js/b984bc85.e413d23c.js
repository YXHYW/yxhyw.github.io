"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4960],{46257:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>d});var i=t(74848),s=t(28453);const r={},l=void 0,a={id:"operation/Prometheus/\u76d1\u63a7nginx",title:"\u76d1\u63a7nginx",description:"\u524d\u8a00",source:"@site/docs/operation/Prometheus/\u76d1\u63a7nginx.md",sourceDirName:"operation/Prometheus",slug:"/operation/Prometheus/\u76d1\u63a7nginx",permalink:"/docs/operation/Prometheus/\u76d1\u63a7nginx",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"opsSidebar",previous:{title:"\u642d\u5efa\u57fa\u7840\u76d1\u63a7\u7cfb\u7edf",permalink:"/docs/operation/Prometheus/\u642d\u5efa\u57fa\u7840\u76d1\u63a7\u7cfb\u7edf"},next:{title:"\u914d\u7f6ealertmanager\u548c\u9489\u9489\u544a\u8b66",permalink:"/docs/operation/Prometheus/\u914d\u7f6ealertmanager\u548c\u9489\u9489\u544a\u8b66"}},o={},d=[{value:"\u524d\u8a00",id:"\u524d\u8a00",level:2},{value:"\u7f16\u8bd1nginx",id:"\u7f16\u8bd1nginx",level:2},{value:"\u4fee\u6539nginx\u914d\u7f6e",id:"\u4fee\u6539nginx\u914d\u7f6e",level:2},{value:"\u90e8\u7f72nginx-vts-exporter",id:"\u90e8\u7f72nginx-vts-exporter",level:2},{value:"\u914d\u7f6ePrometheus",id:"\u914d\u7f6eprometheus",level:2},{value:"\u914d\u7f6egrafana",id:"\u914d\u7f6egrafana",level:2},{value:"\u8865\u5145",id:"\u8865\u5145",level:2},{value:"nginx-vts-exporter\u7684\u542f\u52a8\u811a\u672c",id:"nginx-vts-exporter\u7684\u542f\u52a8\u811a\u672c",level:3}];function p(n){const e={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.h2,{id:"\u524d\u8a00",children:"\u524d\u8a00"}),"\n",(0,i.jsxs)(e.p,{children:["\u9996\u5148nginx\u9700\u8981\u7f16\u8bd1\u7b2c\u4e09\u65b9\u6a21\u5757",(0,i.jsx)(e.code,{children:"nginx-module-vts"}),"\uff0c\u7136\u540e\u901a\u8fc7",(0,i.jsx)(e.code,{children:"nginx-vts-exporter"}),"\u63d0\u4f9bmetrics\uff0c\u63a5\u7740Prometheus\u6536\u96c6nginx-vts-exporter\u63d0\u4f9b\u7684merics\u5373\u53ef\u3002"]}),"\n",(0,i.jsx)(e.h2,{id:"\u7f16\u8bd1nginx",children:"\u7f16\u8bd1nginx"}),"\n",(0,i.jsxs)(e.p,{children:["\u4ed3\u5e93\u5730\u5740\u4e3a\uff1a",(0,i.jsx)(e.a,{href:"https://github.com/vozlt/nginx-module-vts",children:"https://github.com/vozlt/nginx-module-vts"})]}),"\n",(0,i.jsx)(e.p,{children:"\u8fd9\u4e2a\u7b2c\u4e09\u65b9\u6a21\u5757\u6709nginx\u7248\u672c\u4f9d\u8d56\u9650\u5236\uff0c\u5efa\u8bae\u53c2\u8003\u6587\u6863\u4e0b\u8f7d\u5bf9\u5e94\u7684nginx\u7248\u672c\u3002\u8fd9\u91cc\u4f7f\u7528nginx 1.22\u4f5c\u4e3a\u6d4b\u8bd5"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"\u514b\u9686\u4ed3\u5e93"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"git clone --depth=1 --single-branch https://github.com/vozlt/nginx-module-vts.git /tmp/nginx-module-vts\n"})}),"\n",(0,i.jsxs)(e.ol,{start:"2",children:["\n",(0,i.jsx)(e.li,{children:"\u5b89\u88c5\u4f9d\u8d56"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"# yum\nyum -y install gcc pcre-devel zlib-devel openssl-devel libxml2-devel libxslt-devel gd-devel GeoIP-devel jemalloc-devel libatomic_ops-devel perl-devel perl-ExtUtils-Embeb\n\n# apt\napt install -y libpcre3-dev openssl libssl-dev libxml2-dev libgd-dev libxml2 libgeoip-dev libxslt-dev\n"})}),"\n",(0,i.jsxs)(e.ol,{start:"3",children:["\n",(0,i.jsxs)(e.li,{children:["\u9884\u7f16\u8bd1\u3002\u8fd9\u91cc\u52a0\u4e86\u5f88\u591a\u7f16\u8bd1\u53c2\u6570\uff0c\u53ef\u6839\u636e\u5b9e\u9645\u9700\u6c42\u4fee\u6539\uff0c\u4e3b\u8981\u7684\u7f16\u8bd1\u53c2\u6570\u662f",(0,i.jsx)(e.code,{children:"--add-module=/tmp/nginx-module-vts"})]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"./configure --with-threads \\\n    --with-file-aio \\\n    --with-http_ssl_module \\\n    --with-http_v2_module \\\n    --with-http_realip_module \\\n    --with-http_addition_module \\\n    --with-http_xslt_module=dynamic \\\n    --with-http_image_filter_module=dynamic \\\n    --with-http_geoip_module=dynamic \\\n    --with-http_sub_module \\\n    --with-http_dav_module \\\n    --with-http_flv_module \\\n    --with-http_mp4_module \\\n    --with-http_gunzip_module \\\n    --with-http_gzip_static_module \\\n    --with-http_auth_request_module \\\n    --with-http_random_index_module \\\n    --with-http_secure_link_module \\\n    --with-http_degradation_module \\\n    --with-http_slice_module \\\n    --with-http_stub_status_module \\\n    --with-stream \\\n    --with-stream_ssl_module \\\n    --with-stream_realip_module \\\n    --with-stream_geoip_module=dynamic \\\n    --with-stream_ssl_preread_module \\\n    --with-compat \\\n    --with-pcre-jit \\\n    --add-module=/tmp/nginx-module-vts \\\n    --prefix=/home/atlas/apps/nginx-vts\n"})}),"\n",(0,i.jsxs)(e.ol,{start:"4",children:["\n",(0,i.jsxs)(e.li,{children:["\u7f16\u8bd1\u53ca\u5b89\u88c5\u3002\u5982\u679c\u662f\u66f4\u65b0nginx\uff0c\u5c31\u4e0d\u8981",(0,i.jsx)(e.code,{children:"make install"}),"\u4e86\uff0c",(0,i.jsx)(e.code,{children:"make"}),"\u540e\u5c06\u7f16\u8bd1\u7ed3\u679c\u66f4\u65b0\u5230\u539f\u5148nginx\u8def\u5f84\u5373\u53ef\u3002"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"\u4fee\u6539nginx\u914d\u7f6e",children:"\u4fee\u6539nginx\u914d\u7f6e"}),"\n",(0,i.jsx)(e.p,{children:"\u5e38\u7528\u914d\u7f6e\u53c2\u6570\u5982\u4e0b\uff0c\u66f4\u591a\u914d\u7f6e\u53c2\u6570\u53ef\u67e5\u770bnginx-module-vts\u7684\u6587\u6863\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"http {\n    vhost_traffic_status_zone;\n    vhost_traffic_status_filter_by_host on;\n\t# ...\n\tserver {\n\t# ...\n\t    location /status {\n             vhost_traffic_status_display;\n             vhost_traffic_status_display_format html;\n        }\n\t}\n\t# ...\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:["\u542f\u52a8nginx\u540e\uff0c\u8bbf\u95ee",(0,i.jsx)(e.code,{children:"/status"}),"\u8def\u7531\u5373\u53ef\u770b\u5230\u5305\u542bnginx\u72b6\u6001\u4fe1\u606f\u7684\u9875\u9762"]}),"\n",(0,i.jsx)(e.h2,{id:"\u90e8\u7f72nginx-vts-exporter",children:"\u90e8\u7f72nginx-vts-exporter"}),"\n",(0,i.jsxs)(e.p,{children:["\u4ee3\u7801\u4ed3\u5e93\u4e3a",(0,i.jsx)(e.a,{href:"https://github.com/hnlq715/nginx-vts-exporter",children:"https://github.com/hnlq715/nginx-vts-exporter"})]}),"\n",(0,i.jsx)(e.p,{children:"\u5148\u4ece\u4ee3\u7801\u4ed3\u5e93\u7684release\u4e0b\u8f7d\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u538b\u7f29\u5305\u5e76\u89e3\u538b\u5230\u670d\u52a1\u5668\uff0c\u6307\u5b9anginx vts\u7684\u8def\u7531\u6765\u542f\u52a8"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:'./nginx-vtx-exporter -telemetry.address=":19094" -nginx.scrape_uri="http://127.0.0.1:8001/status/format/json"\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u914d\u7f6eprometheus",children:"\u914d\u7f6ePrometheus"}),"\n",(0,i.jsx)(e.p,{children:"prometheus.yml"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-yaml",children:"# ...\nscrape_configs:\n  - job_name: \"nginx\"\n    file_sd_configs:\n    - files: ['/home/atlas/apps/prometheus/prometheus/sd_configs/nginx/*.yaml']\n      refresh_interval:  10s\n"})}),"\n",(0,i.jsx)(e.p,{children:"/home/atlas/apps/prometheus/prometheus/sd_configs/nginx/target.yaml"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-yaml",children:"- targets: ['192.168.1.112:19094']\n  labels:\n    instance: 192.168.1.112\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u914d\u7f6egrafana",children:"\u914d\u7f6egrafana"}),"\n",(0,i.jsx)(e.p,{children:"nginx-vts-exporter\u7684\u4ee3\u7801\u4ed3\u5e93\u4e2d\u9644\u5e26\u4e86\u4e00\u4e2adashboard\u7684json\uff0c\u6d4b\u8bd5\u53ef\u76f4\u63a5\u5bfc\u5165\u5230grafana\u4e2d\u4f7f\u7528\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"\u8865\u5145",children:"\u8865\u5145"}),"\n",(0,i.jsx)(e.h3,{id:"nginx-vts-exporter\u7684\u542f\u52a8\u811a\u672c",children:"nginx-vts-exporter\u7684\u542f\u52a8\u811a\u672c"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n\nset -u\n\nscript_dir=$(cd $(dirname $0) && pwd)\nport=19094\napp_name="nginx-vtx-exporter"\nnginx_scrape_uri="http://127.0.0.1:8001/status/format/json"\n\ncheck_env() {\n    timeout 1 bash -c "cat < /dev/null > /dev/tcp/127.0.0.1/${port}" > /dev/null 2>&1\n    if [ $? -eq 0 ]; then\n        echo "port ${port} has been used"\n        exit 1\n    fi\n}\n\nstart_app() {\n    check_env\n    nohup ${script_dir}/${app_name} \\\n        -nginx.scrape_uri=${nginx_scrape_uri} \\\n        -telemetry.address=":${port}" > /dev/null 2>&1 &\n    echo "start ${app_name} called"\n}\n\nstop_app() {\n\tlocal pid=$(ps -ef | grep -v grep | grep "${script_dir}/${app_name}" | awk \'{print $2}\')\n\tif [ x"${pid}" == x ]; then\n\t\techo "${script_dir}/${app_name} is not runnning"\n\t\texit 0\n\tfi\n\tkill ${pid}\n\techo "stop ${app_name} called"\n}\n\nstatus_app() {\n\tps -ef | grep -v grep | grep "${script_dir}/${app_name}"\n\tif [ $? -ne 0 ]; then\n\t\techo "${script_dir}/${app_name} is not runnning"\n\t\texit 0\n\tfi\n\techo "status ${app_name} called"\n}\n\nmain() {\n    case $1 in\n    \tstart)\n    \t\tstart_app\n    \t\t;;\n    \tstop)\n    \t\tstop_app\n    \t\t;;\n    \tstatus)\n    \t\tstatus_app\n    \t\t;;\n    \t*)\n    \t\techo "Available options: start | stop | status"\n    esac\n}\n\nmain $@\n'})})]})}function h(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(p,{...n})}):p(n)}},28453:(n,e,t)=>{t.d(e,{R:()=>l,x:()=>a});var i=t(96540);const s={},r=i.createContext(s);function l(n){const e=i.useContext(r);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:l(n.components),i.createElement(r.Provider,{value:e},n.children)}}}]);